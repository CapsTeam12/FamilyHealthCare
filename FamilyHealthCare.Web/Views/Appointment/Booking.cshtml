@model ScheduleViewModel
@using Data
@using FamilyHealthCare.SharedLibrary
@{
    ViewData["Title"] = "Booking";
    DateTime currentDate = ViewBag.CurrentDate; // currentDate for search
    var Doctor = ViewBag.doctor; // userId of doctor
    var doctorId = ViewBag.doctorId; // doctorId
    var doctorName = ViewBag.doctorName; // doctor fullname
    var doctorEmail = ViewBag.doctorEmail; // doctor Email

    var currentTime = Convert.ToDateTime(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"));
}

@{
    int diff = (7 + (currentDate.Date.DayOfWeek - DayOfWeek.Monday)) % 7;
    DateTime DateStartOfWeek = currentDate.AddDays(-1 * diff).Date;
}
<!-- Page Content -->
<div class="content">
    <div class="container">
        <div class="row">
            <div class="col-12">

                <div class="card">
                    <div class="card-body">
                        <div class="booking-doc-info">
                            <a href="doctor-profile.html" class="booking-doc-img">
                                @if (Model.doctorDetails.Avatar != null)
                                {
                                    <img src=@(ImageConstants.AVATARS+Model.doctorDetails.Avatar) alt="User Image">
                                }
                                else
                                {
                                    <img src="~/assets/img/doctors/doctor-thumb-02.jpg" alt="User Image">
                                }

                            </a>
                            <div class="booking-info">
                                <h4><a href="doctor-profile.html">Dr. @Model.doctorDetails.FullName </a></h4>
                                <h5>@Model.doctorDetails.Specialities</h5>
                                <p class="text-muted mb-0"><i class="fas fa-map-marker-alt"></i> @Model.doctorDetails.Address</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-sm-4 col-md-6">
                        <h4 class="mb-1">@DateTime.Now.Day @DateTime.Now.ToString("Y")</h4>
                        <p class="text-muted">@DateTime.Now.DayOfWeek</p>
                    </div>
                </div>
                <!-- Schedule Widget -->
                <div class="card booking-schedule schedule-widget">

                    <!-- Schedule Header -->
                    <div class="schedule-header">
                        <div class="row">
                            <div class="col-md-12">

                                <!-- Day Slot -->
                                <div class="day-slot">
                                    <ul>
                                        @if (DateStartOfWeek > DateTime.Now.AddDays(-1 * diff).Date)
                                        {
                                            <li class="left-arrow">
                                                <a asp-controller="Appointment" asp-action="Booking"
                                                   asp-route-accountDoctorId="@Doctor" asp-route-therapistId="@doctorId" asp-route-date="@DateStartOfWeek.AddDays(-7).Date"
                                                   asp-route-doctorName="@doctorName" asp-route-doctorEmail="@doctorEmail">
                                                    <i class="fa fa-chevron-left"></i>
                                                </a>
                                            </li>
                                        }

                                        @for (int i = 0; i < 7; i++)
                                        {
                                            <li>
                                                <span class="textDayOfWeek">@DateStartOfWeek.AddDays(i).DayOfWeek</span>
                                                <span class="slot-date textDayAndMonth">@DateStartOfWeek.AddDays(i).Day-@DateStartOfWeek.AddDays(i).Month-<small class="slot-year textYear">@DateStartOfWeek.AddDays(i).Year</small></span>
                                            </li>
                                        }

                                        <li class="right-arrow">
                                            <a asp-controller="Appointment" asp-action="Booking"
                                               asp-route-accountDoctorId="@Doctor" asp-route-therapistId="@doctorId" asp-route-date="@DateStartOfWeek.AddDays(7).Date"
                                               asp-route-doctorName="@doctorName" asp-route-doctorEmail="@doctorEmail">
                                                <i class="fa fa-chevron-right"></i>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                <!-- /Day Slot -->

                            </div>
                        </div>
                    </div>
                    <!-- /Schedule Header -->
                    <!-- Schedule Content -->
                    <div class="schedule-cont">
                        <div class="row">
                            <div class="col-md-12">
                                <!-- Time Slot -->
                                <div class="time-slot">
                                    <ul class="clearfix">
                                        @for (int i = 0; i < 7; i++)
                                        {
                                            var dateInWeek = DateStartOfWeek.AddDays(i).Date;
                                            if (Model.ScheduleDoctors.Where(s => s.Date >= dateInWeek).Count() > 0)
                                            {
                                                <li>
                                                    @foreach (var timing in Model.ScheduleDoctors.Where(x => x.Date == dateInWeek.Date && x.IsBooking != true))
                                                    {
                                                        if (timing != null)
                                                        {
                                                            foreach (var shifts in Model.Shifts.Where(s => s.Id == timing.ShiftId))
                                                            {
                                                                var timeOfShifts = Convert.ToDateTime(timing.Date.ToString("yyyy-MM-dd") + " " + shifts.TimeSlot.Split("-")[0]);
                                                                if (DateTime.Compare(currentTime, timeOfShifts) < 0)
                                                                {
                                                                    <a class="timing" asp-action="BookingSummary" asp-controller="Appointment" asp-route-accountDoctorId="@Doctor"
                                                                       asp-route-therapistId="@doctorId" asp-route-Date="@timing.Date.ToString("yyyy-MM-dd")"
                                                                       asp-route-doctorName="@doctorName" asp-route-doctorEmail="@doctorEmail" asp-route-Time="@shifts.TimeSlot">
                                                                        <span>@shifts.TimeSlot.Split('-')[0].Substring(0, 5)</span>
                                                                    </a>
                                                                }
                                                                @*else
                                                                    {
                                                                        <i>No appointment</i>
                                                                    }*@
                                                            }
                                                        }
                                                    }
                                                </li>
                                            }
                                            else
                                            {
                                                @*<li style="padding-left:20px;">
                                                    <i>No appointment</i>
                                                </li>*@
                                            }
                                        }
                                    </ul>
                                </div>
                                <!-- /Time Slot -->

                            </div>
                        </div>
                    </div>
                    <!-- /Schedule Content -->

                </div>
                <!-- /Schedule Widget -->

            </div>
        </div>
    </div>
</div>

<!-- /Page Content -->

@{
    ViewData["Title"] = "Dashboard";
    ViewData["breadcumb-title"] = "Dashboard";
    int diff = (7 + (DateTime.Now.Date.DayOfWeek - DayOfWeek.Monday)) % 7;
    DateTime DateStartOfWeek = DateTime.Now.AddDays(-1 * diff).Date;
}
<h4 id="dateStartOfWeek" hidden>@DateStartOfWeek</h4>
<div class="row">
    <div class="col-xl-3 col-sm-6 col-12">
        <div class="card">
            <div class="card-body">
                <div class="dash-widget-header">
                    <span class="dash-widget-icon text-primary border-primary">
                        <i class="fe fe-users"></i>
                    </span>
                    <div class="dash-count">
                        <h3 id="doctors"></h3>
                    </div>
                </div>
                <div class="dash-widget-info">
                    <h6 class="text-muted">Doctors</h6>
                    <div class="progress progress-sm">
                        <div class="progress-bar bg-primary w-100"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6 col-12">
        <div class="card">
            <div class="card-body">
                <div class="dash-widget-header">
                    <span class="dash-widget-icon text-success">
                        <i class="fe fe-credit-card"></i>
                    </span>
                    <div class="dash-count">
                        <h3 id="patients"></h3>
                    </div>
                </div>
                <div class="dash-widget-info">

                    <h6 class="text-muted">Patients</h6>
                    <div class="progress progress-sm">
                        <div class="progress-bar bg-success w-100"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6 col-12">
        <div class="card">
            <div class="card-body">
                <div class="dash-widget-header">
                    <span class="dash-widget-icon text-danger border-danger">
                        <i class="fe fe-money"></i>
                    </span>
                    <div class="dash-count">
                        <h3 id="appointments"></h3>
                    </div>
                </div>
                <div class="dash-widget-info">

                    <h6 class="text-muted">Appointment</h6>
                    <div class="progress progress-sm">
                        <div class="progress-bar bg-danger w-100"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-sm-6 col-12">
        <div class="card">
            <div class="card-body">
                <div class="dash-widget-header">
                    <span class="dash-widget-icon text-warning border-warning">
                        <i class="fe fe-folder"></i>
                    </span>
                    <div class="dash-count">
                        <h3 id="pharmacies"></h3>
                    </div>
                </div>
                <div class="dash-widget-info">

                    <h6 class="text-muted">Pharmacy</h6>
                    <div class="progress progress-sm">
                        <div class="progress-bar bg-warning w-100"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12 col-lg-6">

        <!-- Sales Chart -->
        <div class="card card-chart">
            <div class="card-header">
                <h4 class="card-title">Appointment</h4>
            </div>
            <div class="card-body">
                <div id="morrisArea"></div>
            </div>
        </div>
        <!-- /Sales Chart -->

    </div>
    <div class="col-md-12 col-lg-6">

        <!-- Invoice Chart -->
        <div class="card card-chart">
            <div class="card-header">
                <h4 class="card-title">Status</h4>
            </div>
            <div class="card-body">
                <div id="morrisLine"></div>
            </div>
        </div>
        <!-- /Invoice Chart -->

    </div>
</div>

@section scripts{ 
<script>
    $(document).ready(function () {
        var dateStartOfWeek = new Date($('#dateStartOfWeek').text());
        var dataMorrisArea = [];
        var dataMorrisLine = [];
        Date.prototype.addDays = function (days) {
            var date = new Date(this.valueOf());
            date.setDate(date.getDate() + days);
            return date;
        }
        GetAppointments();
        GetDoctors();
        GetPatients();
        GetPharmacies();
        $(window).on("resize", function () {
            mA.redraw();
            mL.redraw();
        });

        function GetDoctors() {
            $.ajax({
                url: '/Home/GetDoctors',
                type: 'GET',
                success: function (res) {
                    if (res.success) {
                        var doctors = res.item;
                        $('#doctors').text(doctors);
                    }
                }
            });
        }

        function GetPatients() {
            $.ajax({
                url: '/Home/GetPatients',
                type: 'GET',
                success: function (res) {
                    if (res.success) {
                        var patients = res.item;
                        $('#patients').text(patients);
                    }
                }
            });
        }

        function GetPharmacies() {
            $.ajax({
                url: '/Home/GetPharmacies',
                type: 'GET',
                success: function (res) {
                    if (res.success) {
                        var pharmacies = res.item;
                        $('#pharmacies').text(pharmacies);
                    }
                }
            });
        }

        function GetAppointments() {
            $.ajax({
                url: '/Home/GetAppointments',
                type: 'GET',
                success: function (res) {
                    if (res.success) {
                        var appointments = res.item;
                        console.log(appointments);
                        $('#appointments').text(appointments.length);
                        for (var i = 0; i < 7; i++) {
                            var countTotal = 0; 
                            var countBooked = 0;
                            var countCanceled = 0;

                            var dateOfWeekToCompare = dateStartOfWeek.addDays(i).toLocaleDateString();
                            var dateOfWeek = moment(dateStartOfWeek.addDays(i)).format('YYYY-MM-DD');
                            for (var j = 0; j < appointments.length; j++) {
                                var appointment = appointments[j];
                                var dateAppointment = new Date(appointment.startTime).toLocaleDateString();
                                if (dateAppointment == dateOfWeekToCompare) {
                                    countTotal++;
                                }
                                if (dateAppointment == dateOfWeekToCompare && (appointment.status === 1 || appointment.status === 2 || appointment.status === 3)) {
                                    countBooked++;
                                }
                                if (dateAppointment == dateOfWeekToCompare && appointment.status === 4) {
                                    countCanceled++;
                                }

                            }
                            var AreaObj = {
                                y: dateOfWeek,
                                a: countTotal
                            };
                            dataMorrisArea.push(AreaObj);

                            var LineObj = {
                                y: dateOfWeek,
                                a: countBooked,
                                b: countCanceled
                            };
                            dataMorrisLine.push(LineObj);
                            
                        }
                        console.log(dataMorrisArea);
                        console.log(dataMorrisLine);
                        /* Morris Area Chart */
                        window.mA = Morris.Area({
                            element: 'morrisArea',
                            data: dataMorrisArea,
                            xkey: 'y',
                            ykeys: ['a'],
                            labels: ['Appointments'],
                            lineColors: ['#1b5a90'],
                            lineWidth: 2,
                            xLabelFormat: function (d) {
                                return ("0" + d.getDate()).slice(-2) + '-' + ("0" + (d.getMonth() + 1)).slice(-2) + '-' + d.getFullYear();
                            },

                            fillOpacity: 0.5,
                            gridTextSize: 10,
                            hideHover: 'auto',
                            resize: true,
                            redraw: true
                        });
                        /* Morris Line Chart */
                        window.mL = Morris.Line({
                            element: 'morrisLine',
                            data: dataMorrisLine,
                            xkey: 'y',
                            ykeys: ['a', 'b'],
                            labels: ['Booked', 'Canceled'],
                            lineColors: ['#1b5a90', '#ff9d00'],
                            lineWidth: 1,
                            xLabelFormat: function (d) {
                                return ("0" + d.getDate()).slice(-2) + '-' + ("0" + (d.getMonth() + 1)).slice(-2) + '-' + d.getFullYear();
                            },
                            gridTextSize: 10,
                            hideHover: 'auto',
                            resize: true,
                            redraw: true
                        });
                    }
                }
            });
        }

    });
</script>
}